<!DOCTYPE html>
<html>
<head>
    <title>æ”¯ä»˜å®ARåŸå¸‚å¯»å®</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            color: white;
            overflow-x: hidden;
        }
        
        .status-bar {
            background: rgba(0, 0, 0, 0.85);
            padding: 12px 20px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .header {
            text-align: center;
            padding: 40px 0 30px;
        }
        
        .logo {
            font-size: 72px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            margin: 0 0 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, #00a8ff, #0097e6);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin: 12px 0;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 168, 255, 0.4);
        }
        
        .btn-alipay {
            background: linear-gradient(to right, #1296db, #0d8bd9);
        }
        
        .btn-orange {
            background: linear-gradient(to right, #FF9500, #FF5E3A);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .game-stats {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
        }
        
        .stat-label {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* æ”¯ä»˜å®å“ç‰Œå…ƒç´  */
        .alipay-badge {
            background: rgba(18, 150, 219, 0.2);
            border: 1px solid rgba(18, 150, 219, 0.4);
            color: #1296db;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: inline-block;
            margin: 0 5px;
        }
        
        .alipay-card {
            background: linear-gradient(135deg, rgba(18, 150, 219, 0.1), rgba(13, 139, 217, 0.2));
            border: 1px solid rgba(18, 150, 219, 0.3);
        }
        
        /* åœ°å›¾æ ·å¼ */
        .city-map {
            height: 350px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            position: relative;
            margin: 25px 0;
            overflow: hidden;
        }
        
        .map-marker {
            position: absolute;
            width: 42px;
            height: 42px;
            background: rgba(18, 150, 219, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
            border: 2px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .map-marker.collected {
            background: rgba(46, 204, 113, 0.9);
        }
        
        .map-marker:hover {
            transform: translate(-50%, -50%) scale(1.15);
        }
        
        .location-list {
            margin-top: 20px;
        }
        
        .location-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }
        
        .location-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .location-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }
        
        /* ARæ‰«ææ ·å¼ */
        .ar-scanner {
            background: #000;
            height: 380px;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            margin: 25px 0;
        }
        
        .scanner-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 240px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }
        
        .frame-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #1296db;
        }
        
        .frame-corner.tl { top: -2px; left: -2px; border-right: none; border-bottom: none; }
        .frame-corner.tr { top: -2px; right: -2px; border-left: none; border-bottom: none; }
        .frame-corner.bl { bottom: -2px; left: -2px; border-right: none; border-top: none; }
        .frame-corner.br { bottom: -2px; right: -2px; border-left: none; border-top: none; }
        
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #1296db, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .floating-packet {
            position: absolute;
            font-size: 60px;
            cursor: pointer;
            transition: all 0.3s;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }
        
        .ar-controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .ar-controls .btn {
            flex: 1;
            margin: 0;
        }
        
        /* æ”¯ä»˜å®å¡åˆ¸æ ·å¼ */
        .coupon-card {
            background: linear-gradient(135deg, #fff8e1, #fff3cd);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            color: #333;
            border-left: 5px solid #FF9500;
        }
        
        .coupon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .coupon-value {
            font-size: 28px;
            font-weight: bold;
            color: #FF9500;
        }
        
        .coupon-code {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
            border: 1px dashed #ddd;
        }
        
        .progress-container {
            margin: 25px 0;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #00b09b, #96c93d);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* å•†å®¶åˆä½œå±•ç¤º */
        .merchant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .merchant-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .merchant-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .merchant-logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 10px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #333;
        }
        
        @media (max-width: 480px) {
            .container { padding: 0 12px; }
            .header { padding: 30px 0 20px; }
            .logo { font-size: 60px; }
            h1 { font-size: 28px; }
            .card { padding: 20px; }
            .city-map { height: 300px; }
            .ar-scanner { height: 340px; }
        }
    </style>
</head>
<body>
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div>
            <span class="alipay-badge">æ”¯ä»˜å®AR</span>
            <span>åŸå¸‚å¯»å®</span>
        </div>
        <div id="currentTime"></div>
        <div>ä½™é¢: <span id="alipayBalance">0.00</span>å…ƒ</div>
    </div>
    
    <div class="container">
        <!-- é¦–é¡µ -->
        <div id="homeScreen" class="screen active">
            <div class="header">
                <div class="logo">ğŸ§§</div>
                <h1>æ”¯ä»˜å®ARåŸå¸‚å¯»å®</h1>
                <p class="subtitle">åŸºäºæ”¯ä»˜å®å¼€æ”¾å¹³å° Â· çœŸå®å•†ä¸šç”Ÿæ€</p>
            </div>
            
            <div class="card alipay-card">
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="foundCount">0</div>
                        <div class="stat-label">å·²å‘ç°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCount">5</div>
                        <div class="stat-label">çº¢åŒ…æ€»æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="rewardValue">0</div>
                        <div class="stat-label">ç´¯è®¡ä»·å€¼</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text">
                        <span>å‘ç°è¿›åº¦</span>
                        <span id="progressPercent">0%</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px; font-size: 13px; opacity: 0.8;">
                    å·²å¯¹æ¥ <span style="color: #FFD700;">12</span> å®¶æ”¯ä»˜å®å•†æˆ·
                </div>
            </div>
            
            <button class="btn btn-alipay" onclick="showScreen('map')">
                <span style="font-size: 20px; margin-right: 8px;">ğŸ—ºï¸</span>
                æŸ¥çœ‹ARè—å®åœ°å›¾
            </button>
            
            <button class="btn" onclick="showScreen('ar')">
                <span style="font-size: 20px; margin-right: 8px;">ğŸ“·</span>
                æ”¯ä»˜å®ARæ‰«æ
            </button>
            
            <button class="btn btn-orange" onclick="showScreen('wallet')">
                <span style="font-size: 20px; margin-right: 8px;">ğŸ’°</span>
                æˆ‘çš„æ”¯ä»˜å®å¡åŒ…
            </button>
            
            <div class="card" style="margin-top: 25px;">
                <h3 style="margin-bottom: 15px; display: flex; align-items: center;">
                    <span style="color: #1296db; margin-right: 8px;">âš¡</span>
                    æ”¯ä»˜å®èƒ½åŠ›æ¥å…¥
                </h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                    <span class="alipay-badge">ARè¯†åˆ«</span>
                    <span class="alipay-badge">å°ç¨‹åºæ¡†æ¶</span>
                    <span class="alipay-badge">å¡åˆ¸å‘æ”¾</span>
                    <span class="alipay-badge">åœ°å›¾æœåŠ¡</span>
                    <span class="alipay-badge">æ”¯ä»˜èƒ½åŠ›</span>
                    <span class="alipay-badge">ä¼šå‘˜ä½“ç³»</span>
                </div>
            </div>
            
            <!-- åˆä½œå•†å®¶å±•ç¤º -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">ğŸª åˆä½œå•†å®¶</h3>
                <div class="merchant-grid">
                    <div class="merchant-card">
                        <div class="merchant-logo">â˜•</div>
                        <div style="font-size: 12px; font-weight: 500;">æ˜Ÿå·´å…‹</div>
                    </div>
                    <div class="merchant-card">
                        <div class="merchant-logo">ğŸ”</div>
                        <div style="font-size: 12px; font-weight: 500;">éº¦å½“åŠ³</div>
                    </div>
                    <div class="merchant-card">
                        <div class="merchant-logo">ğŸ¬</div>
                        <div style="font-size: 12px; font-weight: 500;">ä¸‡è¾¾å½±åŸ</div>
                    </div>
                    <div class="merchant-card">
                        <div class="merchant-logo">ğŸ›ï¸</div>
                        <div style="font-size: 12px; font-weight: 500;">é“¶æ³°ç™¾è´§</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åœ°å›¾ç•Œé¢ -->
        <div id="mapScreen" class="screen">
            <div class="card">
                <h2 style="margin-bottom: 20px; display: flex; align-items: center;">
                    <span style="color: #1296db; margin-right: 8px;">ğŸ—ºï¸</span>
                    æ”¯ä»˜å®LBSè—å®åœ°å›¾
                </h2>
                
                <div class="city-map" id="cityMap">
                    <!-- åœ°å›¾æ ‡è®°é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
                
                <h3 style="margin: 25px 0 15px;">ğŸ“ ARçº¢åŒ…è—ç‚¹</h3>
                <div class="location-list" id="locationList">
                    <!-- åœ°ç‚¹åˆ—è¡¨é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
            
            <button class="btn btn-alipay" onclick="showScreen('ar')">
                <span style="font-size: 20px; margin-right: 8px;">ğŸ“·</span>
                ä½¿ç”¨æ”¯ä»˜å®ARæ‰«æ
            </button>
            <button class="btn btn-outline" onclick="showScreen('home')">
                â† è¿”å›é¦–é¡µ
            </button>
        </div>
        
        <!-- ARæ‰«æç•Œé¢ -->
        <div id="arScreen" class="screen">
            <div class="card">
                <h2 style="margin-bottom: 15px; display: flex; align-items: center;">
                    <span style="color: #1296db; margin-right: 8px;">ğŸ“·</span>
                    æ”¯ä»˜å®ARæ‰«æ
                </h2>
                <p style="opacity: 0.8; margin-bottom: 20px;">è°ƒç”¨æ”¯ä»˜å®ARè¯†åˆ«èƒ½åŠ›ï¼Œæ‰«æå•†æˆ·æ ‡è¯†å›¾æ¡ˆ</p>
                
                <div class="ar-scanner" id="arScanner">
                    <div class="scanner-grid"></div>
                    <div class="scan-frame">
                        <div class="frame-corner tl"></div>
                        <div class="frame-corner tr"></div>
                        <div class="frame-corner bl"></div>
                        <div class="frame-corner br"></div>
                        <div class="scan-line"></div>
                    </div>
                    <!-- æµ®åŠ¨çº¢åŒ…é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
                
                <div style="background: rgba(18, 150, 219, 0.1); padding: 15px; border-radius: 12px; margin: 20px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="color: #1296db; margin-right: 8px;">ğŸ”</span>
                        <span style="font-weight: 500;">æ”¯ä»˜å®ARèƒ½åŠ›è°ƒç”¨ä¸­</span>
                    </div>
                    <div style="font-size: 13px; opacity: 0.8;">
                        ç‰¹å¾è¯†åˆ«: <span id="arStatus">å‡†å¤‡å°±ç»ª</span>
                    </div>
                </div>
                
                <div class="ar-controls">
                    <button class="btn btn-alipay" onclick="startAlipayARScan()">
                        <span style="font-size: 18px; margin-right: 8px;">âš¡</span>
                        è°ƒç”¨æ”¯ä»˜å®AR
                    </button>
                    <button class="btn" onclick="showHint()">
                        <span style="font-size: 18px; margin-right: 8px;">ğŸ’¡</span>
                        ä½¿ç”¨æç¤º
                    </button>
                </div>
            </div>
            
            <button class="btn btn-orange" onclick="collectPacket()">
                <span style="font-size: 20px; margin-right: 8px;">ğŸ</span>
                é¢†å–æ”¯ä»˜å®å¡åˆ¸
            </button>
            <button class="btn btn-outline" onclick="showScreen('map')">
                <span style="font-size: 18px; margin-right: 8px;">ğŸ—ºï¸</span>
                é€‰æ‹©å…¶ä»–è—ç‚¹
            </button>
        </div>
        
        <!-- æ”¯ä»˜å®å¡åŒ…ç•Œé¢ -->
        <div id="walletScreen" class="screen">
            <div class="card">
                <h2 style="margin-bottom: 25px; display: flex; align-items: center;">
                    <span style="color: #1296db; margin-right: 8px;">ğŸ’°</span>
                    æˆ‘çš„æ”¯ä»˜å®å¡åŒ…
                </h2>
                
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span>æ”¯ä»˜å®ä½™é¢</span>
                        <span style="font-size: 24px; font-weight: bold; color: #FFD700;" id="walletBalance">0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ç´¯è®¡è·å¾—çº¢åŒ…</span>
                        <span style="font-size: 18px; font-weight: bold;" id="totalCoupons">0ä¸ª</span>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 20px;">ğŸ« å·²è·å¾—å¡åˆ¸</h3>
                <div id="couponList">
                    <!-- å¡åˆ¸åˆ—è¡¨é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                    <div style="font-size: 13px; opacity: 0.8; margin-bottom: 10px;">å¡åˆ¸å·²åŒæ­¥è‡³æ”¯ä»˜å®APP</div>
                    <button class="btn btn-alipay" style="padding: 10px 20px; width: auto; display: inline-block;" 
                            onclick="openAlipayApp()">
                        æ‰“å¼€æ”¯ä»˜å®ä½¿ç”¨
                    </button>
                </div>
            </div>
            
            <button class="btn" onclick="showScreen('home')">
                â† è¿”å›é¦–é¡µ
            </button>
        </div>
        
        <!-- é¡µè„š -->
        <div style="text-align: center; padding: 30px 0 20px; color: rgba(255, 255, 255, 0.6); font-size: 13px;">
            <p>åŸºäºæ”¯ä»˜å®å¼€æ”¾å¹³å°æ„å»º Â· å¤©æ± å¤§èµ›å‚èµ›é¡¹ç›®</p>
            <p style="margin-top: 5px; font-size: 12px;">æ”¯ä»˜å®å°ç¨‹åº | ARå¼€æ”¾èƒ½åŠ› | å¡åˆ¸å¹³å° | LBSæœåŠ¡</p>
        </div>
    </div>

    <script>
        // ==================== æ”¯ä»˜å®é›†æˆæ•°æ® ====================
        const alipayData = {
            // ç”¨æˆ·æ•°æ®
            userInfo: {
                balance: 158.60,
                userId: 'ALIPAY_UID_' + Math.random().toString(36).substr(2, 9),
                nickName: 'æ”¯ä»˜å®ç”¨æˆ·',
                level: 'é»„é‡‘ä¼šå‘˜'
            },
            
            // ARçº¢åŒ…æ•°æ®
            packetsCollected: [],
            totalPackets: 5,
            currentScreen: 'home',
            
            // æ”¯ä»˜å®åˆä½œå•†æˆ·
            merchants: [
                { 
                    id: 1, 
                    name: "æ˜Ÿå·´å…‹å’–å•¡", 
                    icon: "â˜•", 
                    x: 25, y: 30, 
                    reward: { type: "coupon", value: "ä¹°ä¸€é€ä¸€åˆ¸", code: "SBUX2024" },
                    color: "#06D6A0",
                    alipayMerchantId: "2088xxxxxx001"
                },
                { 
                    id: 2, 
                    name: "éº¦å½“åŠ³é¤å…", 
                    icon: "ğŸ”", 
                    x: 60, y: 45, 
                    reward: { type: "discount", value: "8æŠ˜ä¼˜æƒ ", code: "MCD2024" },
                    color: "#FFD166",
                    alipayMerchantId: "2088xxxxxx002"
                },
                { 
                    id: 3, 
                    name: "ä¸‡è¾¾å½±åŸ", 
                    icon: "ğŸ¬", 
                    x: 40, y: 65, 
                    reward: { type: "ticket", value: "ç”µå½±ç¥¨", code: "WANDA2024" },
                    color: "#EF476F",
                    alipayMerchantId: "2088xxxxxx003"
                },
                { 
                    id: 4, 
                    name: "é“¶æ³°ç™¾è´§", 
                    icon: "ğŸ›ï¸", 
                    x: 70, y: 25, 
                    reward: { type: "voucher", value: "50å…ƒåˆ¸", code: "YINT2024" },
                    color: "#118AB2",
                    alipayMerchantId: "2088xxxxxx004"
                },
                { 
                    id: 5, 
                    name: "æ»´æ»´å‡ºè¡Œ", 
                    icon: "ğŸš—", 
                    x: 50, y: 80, 
                    reward: { type: "coupon", value: "æ‰“è½¦åˆ¸", code: "DIDI2024" },
                    color: "#073B4C",
                    alipayMerchantId: "2088xxxxxx005"
                }
            ],
            
            // å·²è·å¾—çš„å¡åˆ¸
            collectedCoupons: [],
            
            // æ”¯ä»˜å®APIæ¨¡æ‹Ÿ
            apis: {
                AR: {
                    scan: () => {
                        return new Promise((resolve) => {
                            setTimeout(() => {
                                resolve({
                                    success: true,
                                    data: {
                                        type: 'merchant_logo',
                                        confidence: 0.92,
                                        merchantId: alipayData.merchants[alipayData.packetsCollected.length]?.alipayMerchantId
                                    }
                                });
                            }, 1500);
                        });
                    }
                },
                Coupon: {
                    issue: (userId, merchantId, couponType) => {
                        return new Promise((resolve) => {
                            setTimeout(() => {
                                const couponCode = 'ALP' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase();
                                resolve({
                                    success: true,
                                    data: {
                                        couponCode: couponCode,
                                        issueTime: new Date().toISOString(),
                                        expireTime: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                                    }
                                });
                            }, 800);
                        });
                    }
                },
                Wallet: {
                    getBalance: (userId) => {
                        return new Promise((resolve) => {
                            resolve({
                                success: true,
                                data: {
                                    availableBalance: alipayData.userInfo.balance,
                                    totalBalance: alipayData.userInfo.balance + 50.00
                                }
                            });
                        });
                    }
                }
            }
        };
        
        // ==================== æ”¯ä»˜å®åŠŸèƒ½æ¨¡å— ====================
        function updateAlipayUI() {
            // æ›´æ–°ä½™é¢æ˜¾ç¤º
            document.getElementById('alipayBalance').textContent = alipayData.userInfo.balance.toFixed(2);
            document.getElementById('walletBalance').textContent = alipayData.userInfo.balance.toFixed(2);
            
            // æ›´æ–°è¿›åº¦
            const progress = (alipayData.packetsCollected.length / alipayData.totalPackets) * 100;
            const totalValue = alipayData.packetsCollected.length * 20; // æ¯ä¸ªçº¢åŒ…å¹³å‡ä»·å€¼20å…ƒ
            
            document.getElementById('foundCount').textContent = alipayData.packetsCollected.length;
            document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('rewardValue').textContent = totalValue;
            document.getElementById('totalCoupons').textContent = `${alipayData.collectedCoupons.length}ä¸ª`;
        }
        
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0');
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // ==================== æ”¯ä»˜å®ARæ‰«æ ====================
        async function startAlipayARScan() {
            const arStatus = document.getElementById('arStatus');
            if (!arStatus) return;
            
            // æ›´æ–°çŠ¶æ€
            arStatus.textContent = 'ç‰¹å¾è¯†åˆ«ä¸­...';
            arStatus.style.color = '#FFD700';
            
            // æ¨¡æ‹Ÿè°ƒç”¨æ”¯ä»˜å®AR API
            try {
                const result = await alipayData.apis.AR.scan();
                
                if (result.success) {
                    arStatus.textContent = 'è¯†åˆ«æˆåŠŸ âœ“';
                    arStatus.style.color = '#2ecc71';
                    
                    // æ˜¾ç¤ºçº¢åŒ…
                    const scanner = document.getElementById('arScanner');
                    const floatingPacket = scanner.querySelector('.floating-packet');
                    if (floatingPacket) {
                        floatingPacket.style.display = 'block';
                        floatingPacket.style.animation = 'pulse 0.8s infinite';
                    }
                }
            } catch (error) {
                arStatus.textContent = 'è¯†åˆ«å¤±è´¥ âœ—';
                arStatus.style.color = '#e74c3c';
            }
        }
        
        // ==================== åœ°å›¾åŠŸèƒ½ ====================
        function renderCityMap() {
            const mapElement = document.getElementById('cityMap');
            const locationList = document.getElementById('locationList');
            
            if (!mapElement || !locationList) return;
            
            mapElement.innerHTML = '';
            locationList.innerHTML = '';
            
            alipayData.merchants.forEach(merchant => {
                const isCollected = alipayData.packetsCollected.includes(merchant.id);
                
                // åœ°å›¾æ ‡è®°
                const marker = document.createElement('div');
                marker.className = `map-marker ${isCollected ? 'collected' : ''}`;
                marker.style.left = `${merchant.x}%`;
                marker.style.top = `${merchant.y}%`;
                marker.style.background = isCollected ? 
                    'rgba(46, 204, 113, 0.9)' : 
                    `rgba(${parseInt(merchant.color.slice(1,3), 16)}, ${parseInt(merchant.color.slice(3,5), 16)}, ${parseInt(merchant.color.slice(5,7), 16)}, 0.9)`;
                marker.innerHTML = isCollected ? 'âœ“' : merchant.icon;
                marker.onclick = () => goToLocation(merchant.id);
                
                mapElement.appendChild(marker);
                
                // åœ°ç‚¹åˆ—è¡¨
                const locationItem = document.createElement('div');
                locationItem.className = 'location-item';
                locationItem.onclick = () => goToLocation(merchant.id);
                
                locationItem.innerHTML = `
                    <div class="location-icon" style="background: ${merchant.color}20; color: ${merchant.color}">
                        ${merchant.icon}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${merchant.name}</div>
                        <div style="font-size: 13px; opacity: 0.7; margin-top: 3px;">
                            å¥–åŠ±: <span style="color: ${merchant.color}">${merchant.reward.value}</span>
                        </div>
                        <div style="font-size: 11px; opacity: 0.5; margin-top: 2px;">
                            æ”¯ä»˜å®å•†æˆ·ID: ${merchant.alipayMerchantId}
                        </div>
                    </div>
                    <div style="font-size: 24px; opacity: ${isCollected ? '1' : '0.3'}; color: ${isCollected ? '#2ecc71' : 'inherit'}">
                        ${isCollected ? 'âœ“' : 'â—‹'}
                    </div>
                `;
                
                locationList.appendChild(locationItem);
            });
        }
        
        function goToLocation(locationId) {
            const merchant = alipayData.merchants.find(m => m.id === locationId);
            if (!merchant) return;
            
            const isCollected = alipayData.packetsCollected.includes(locationId);
            
            if (!isCollected) {
                showScreen('ar');
                initARScanner();
            }
        }
        
        // ==================== ARæ‰«æåˆå§‹åŒ– ====================
        function initARScanner() {
            const scanner = document.getElementById('arScanner');
            if (!scanner) return;
            
            // ç§»é™¤ç°æœ‰çš„çº¢åŒ…
            const existingPacket = scanner.querySelector('.floating-packet');
            if (existingPacket) {
                existingPacket.remove();
            }
            
            // å¯»æ‰¾æœªæ”¶é›†çš„çº¢åŒ…
            const nextMerchant = alipayData.merchants.find(m => 
                !alipayData.packetsCollected.includes(m.id)
            );
            
            if (nextMerchant) {
                const packet = document.createElement('div');
                packet.className = 'floating-packet';
                packet.innerHTML = 'ğŸ§§';
                packet.style.left = `${30 + Math.random() * 40}%`;
                packet.style.top = `${30 + Math.random() * 40}%`;
                packet.style.color = nextMerchant.color;
                packet.style.display = 'none'; // åˆå§‹éšè—ï¼ŒARè¯†åˆ«åæ˜¾ç¤º
                packet.onclick = () => collectAlipayPacket(nextMerchant.id);
                
                scanner.appendChild(packet);
            }
        }
        
        // ==================== é¢†å–æ”¯ä»˜å®çº¢åŒ… ====================
        async function collectAlipayPacket(merchantId) {
            const merchant = alipayData.merchants.find(m => m.id === merchantId);
            if (!merchant || alipayData.packetsCollected.includes(merchantId)) {
                return;
            }
            
            // æ¨¡æ‹Ÿè°ƒç”¨æ”¯ä»˜å®å¡åˆ¸å‘æ”¾API
            const arStatus = document.getElementById('arStatus');
            if (arStatus) {
                arStatus.textContent = 'å‘æ”¾å¡åˆ¸ä¸­...';
                arStatus.style.color = '#FFD700';
            }
            
            try {
                const couponResult = await alipayData.apis.Coupon.issue(
                    alipayData.userInfo.userId,
                    merchant.alipayMerchantId,
                    merchant.reward.type
                );
                
                if (couponResult.success) {
                    // æ·»åŠ åˆ°å·²æ”¶é›†åˆ—è¡¨
                    alipayData.packetsCollected.push(merchantId);
                    
                    // ä¿å­˜å¡åˆ¸ä¿¡æ¯
                    alipayData.collectedCoupons.push({
                        merchant: merchant.name,
                        reward: merchant.reward.value,
                        code: couponResult.data.couponCode,
                        issueTime: couponResult.data.issueTime,
                        expireTime: couponResult.data.expireTime,
                        icon: merchant.icon,
                        color: merchant.color
                    });
                    
                    // å¢åŠ ä½™é¢
                    alipayData.userInfo.balance += 5.00; // æ¯ä¸ªçº¢åŒ…å¢åŠ 5å…ƒ
                    
                    // æ˜¾ç¤ºæ”¶é›†æ•ˆæœ
                    showAlipayCollectionEffect(merchant);
                    
                    // æ›´æ–°UI
                    updateAlipayUI();
                    renderCouponList();
                    
                    if (arStatus) {
                        arStatus.textContent = 'å‘æ”¾æˆåŠŸ âœ“';
                        arStatus.style.color = '#2ecc71';
                    }
                    
                    // å¦‚æœæ”¶é›†å®Œæˆ
                    if (alipayData.packetsCollected.length >= alipayData.totalPackets) {
                        setTimeout(() => {
                            showScreen('wallet');
                        }, 1500);
                    }
                }
            } catch (error) {
                if (arStatus) {
                    arStatus.textContent = 'å‘æ”¾å¤±è´¥ âœ—';
                    arStatus.style.color = '#e74c3c';
                }
            }
        }
        
        function showAlipayCollectionEffect(merchant) {
            const scanner = document.getElementById('arScanner');
            if (!scanner) return;
            
            const effect = document.createElement('div');
            effect.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 80px;
                z-index: 100;
                animation: alipayCollect 1s ease-out forwards;
                pointer-events: none;
            `;
            effect.innerHTML = 'ğŸ’°';
            effect.style.color = merchant.color;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes alipayCollect {
                    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
                    30% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
                    50% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    70% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
                    100% { transform: translate(-50%, -150%) scale(0.8); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            scanner.appendChild(effect);
            
            setTimeout(() => {
                if (effect.parentNode) effect.remove();
                if (style.parentNode) style.remove();
                initARScanner();
            }, 1200);
        }
        
        // ==================== å¡åˆ¸åˆ—è¡¨ ====================
        function renderCouponList() {
            const couponList = document.getElementById('couponList');
            if (!couponList) return;
            
            if (alipayData.collectedCoupons.length === 0) {
                couponList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; opacity: 0.7;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ</div>
                        <div>å°šæœªè·å¾—å¡åˆ¸</div>
                        <div style="font-size: 13px; margin-top: 10px;">ä½¿ç”¨æ”¯ä»˜å®ARæ‰«æå‘ç°çº¢åŒ…</div>
                    </div>
                `;
                return;
            }
            
            couponList.innerHTML = '';
            
            alipayData.collectedCoupons.forEach((coupon, index) => {
                const couponCard = document.createElement('div');
                couponCard.className = 'coupon-card';
                couponCard.style.animationDelay = `${index * 0.1}s`;
                couponCard.style.opacity = '0';
                couponCard.style.animation = 'fadeIn 0.5s forwards';
                
                const issueDate = new Date(coupon.issueTime);
                const expireDate = new Date(coupon.expireTime);
                
                couponCard.innerHTML = `
                    <div class="coupon-header">
                        <div style="display: flex; align-items: center;">
                            <div style="font-size: 24px; margin-right: 10px; color: ${coupon.color}">
                                ${coupon.icon}
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 16px;">${coupon.merchant}</div>
                                <div style="font-size: 12px; opacity: 0.7;">æ”¯ä»˜å®åˆä½œå•†æˆ·</div>
                            </div>
                        </div>
                        <div class="coupon-value">${coupon.reward}</div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <div style="font-size: 13px; margin-bottom: 8px;">å¡åˆ¸ç¼–å·</div>
                        <div class="coupon-code">${coupon.code}</div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-size: 12px; opacity: 0.7;">
                        <div>
                            <div>å‘æ”¾æ—¶é—´</div>
                            <div style="font-weight: 500;">${issueDate.toLocaleDateString()}</div>
                        </div>
                        <div>
                            <div>æœ‰æ•ˆæœŸè‡³</div>
                            <div style="font-weight: 500;">${expireDate.toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    <button onclick="useCoupon('${coupon.code}')" 
                            style="margin-top: 15px; width: 100%; padding: 10px; background: ${coupon.color}; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">
                        å‰å¾€æ”¯ä»˜å®ä½¿ç”¨
                    </button>
                `;
                
                couponList.appendChild(couponCard);
            });
            
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            const fadeStyle = document.createElement('style');
            fadeStyle.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `;
            document.head.appendChild(fadeStyle);
        }
        
        // ==================== æ”¯ä»˜å®åŠŸèƒ½ ====================
        function useCoupon(couponCode) {
            alert(`å¡åˆ¸ ${couponCode} å·²å‡†å¤‡ä½¿ç”¨\n\nè·³è½¬æ”¯ä»˜å®APPè¿›è¡Œæ ¸é”€...`);
        }
        
        function openAlipayApp() {
            alert('æ­£åœ¨æ‰“å¼€æ”¯ä»˜å®APP...\n\nå¡åˆ¸å·²åŒæ­¥è‡³"æ”¯ä»˜å®-å¡åŒ…"');
        }
        
        function showHint() {
            // åœ¨ARç•Œé¢ä¸Šæ˜¾ç¤ºä¸´æ—¶æç¤º
            const scanner = document.getElementById('arScanner');
            if (scanner) {
                const hintElement = document.createElement('div');
                hintElement.style.cssText = `
                    position: absolute;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 13px;
                    white-space: nowrap;
                    z-index: 10;
                `;
                hintElement.textContent = `ğŸ’¡ å¯¹å‡†å•†æˆ·Logoæ‰«æï¼Œè°ƒç”¨æ”¯ä»˜å®ARè¯†åˆ«`;
                scanner.appendChild(hintElement);
                
                setTimeout(() => {
                    hintElement.remove();
                }, 3000);
            }
        }
        
        // ==================== å±å¹•ç®¡ç† ====================
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenName + 'Screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
                alipayData.currentScreen = screenName;
                
                if (screenName === 'map') {
                    renderCityMap();
                } else if (screenName === 'ar') {
                    initARScanner();
                    document.getElementById('arStatus').textContent = 'å‡†å¤‡å°±ç»ª';
                    document.getElementById('arStatus').style.color = '';
                } else if (screenName === 'wallet') {
                    renderCouponList();
                }
            }
        }
        
        // ==================== åˆå§‹åŒ– ====================
        function initAlipayGame() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
            
            updateAlipayUI();
            
            // æ¨¡æ‹Ÿä»æ”¯ä»˜å®è·å–ç”¨æˆ·ä¿¡æ¯
            setTimeout(() => {
                alipayData.apis.Wallet.getBalance(alipayData.userInfo.userId)
                    .then(result => {
                        if (result.success) {
                            alipayData.userInfo.balance = result.data.availableBalance;
                            updateAlipayUI();
                        }
                    });
            }, 500);
            
            // æ·»åŠ æ”¯ä»˜å®æ ·å¼
            const alipayStyle = document.createElement('style');
            alipayStyle.textContent = `
                .alipay-wave {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    height: 100px;
                    background: linear-gradient(90deg, transparent, rgba(18, 150, 219, 0.1), transparent);
                    animation: wave 8s linear infinite;
                    pointer-events: none;
                    z-index: -1;
                }
                
                @keyframes wave {
                    0% { transform: translateX(-100%); }
                    100% { transform: translateX(100%); }
                }
            `;
            document.head.appendChild(alipayStyle);
            
            // æ·»åŠ æ³¢æµªèƒŒæ™¯
            const wave = document.createElement('div');
            wave.className = 'alipay-wave';
            document.body.appendChild(wave);
            
            console.log('æ”¯ä»˜å®ARå¯»å®ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            console.log('ç”¨æˆ·ID:', alipayData.userInfo.userId);
            console.log('å¯¹æ¥å•†æˆ·æ•°:', alipayData.merchants.length);
        }
        
        // ==================== é¡µé¢åŠ è½½ ====================
        document.addEventListener('DOMContentLoaded', initAlipayGame);
        
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(initAlipayGame, 100);
        }
        
        // ==================== å…¨å±€å‡½æ•° ====================
        window.showScreen = showScreen;
        window.startAlipayARScan = startAlipayARScan;
        window.showHint = showHint;
        window.collectPacket = function() {
            const nextMerchant = alipayData.merchants.find(m => 
                !alipayData.packetsCollected.includes(m.id)
            );
            if (nextMerchant) {
                collectAlipayPacket(nextMerchant.id);
            }
        };
        window.goToLocation = goToLocation;
        window.useCoupon = useCoupon;
        window.openAlipayApp = openAlipayApp;
    </script>
</body>
</html>